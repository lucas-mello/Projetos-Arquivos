<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

  <html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>Jogo da Velha - Fundamentos de IA</title>
<meta charset="utf-8"/>
   <meta name="viewport" content="width=device-width, initial-scale=1">
     <link rel="stylesheet" href="https://v40.pingendo.com/assets/bootstrap/bootstrap-4.0.0-beta.1.css" type="text/css" media="screen"> 
<style type="text/css">
body {
	font: 20px arial;
	background-color:rgba(150,200,150,0.3);

}
h1 {
	margin-bottom: 0;
	font: 29px "arial black";
}
h2 {
	margin-top: 0;
	margin-bottom: 50px;
	font: bold italic 18px arial;
}
#container {
  width: 780px;
  margin: auto;
}
#quadroesq {
  float: left;
  width: 400px;
}
#quadrodir {
  float: left;
  width: 360px;
}
#tabuleiro {
	border-collapse: collapse;
}
#tabuleiro td {
	width: 100px;
	height: 100px;
	font: 60px "arial";
	text-align: center;
	vertical-align: center;
	color: #000;
}
#p00,#p01,#p02, #p10,#p11,#p12 {
	border-bottom: 4px solid #000;
}
#p00,#p01, #p10,#p11, #p20,#p21 {
	border-right: 4px solid #000;
}
.clear {
	clear: both;
}
.bloco {
	float: left;
	width: 76px;
	background: url(fundo.png) no-repeat 10px 12px;
	padding-left: 8px;
	text-align: center;
}
.ativo {
	background-color: #eee;
}
</style>

<!-- Google +1 & Analytics -->
<script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23747942-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<!-- end of Google code -->

<script type="text/javascript">
			
var estado = [];	// estado do tabuleiro na tela
var raiz; 			// primeiro nodo da arvore
var atual;			// ponteiro para o nodo que representa o estado atual do jogo

var pilha = []; // array de ponteiros para nodo - usada para construir a árvore
var nodos = 0;	// nodos na árvore

/* objeto nodo: 

	{ pai: ponteiro para nodo,
	  estado: array[3][3] de char,
	  filhos: array de ponteiros para nodo,
	  jogador: char,
	  minimax: int }
*/

function inicializa() {
	estado = [ [],[],[] ];
	raiz = null;
	atual = null;
	
	exibeEstado(estado);
	
	document.getElementById("CPUcomeca").style.display = '';
	document.getElementById("reiniciar").style.display = 'none';
	document.getElementById("info").style.display = 'none';
	document.getElementById("infoFilhos").style.display = 'none';
	document.getElementById("quadroFilhos").innerHTML = '';
	mostraNetos();
}

function geraArvore() {
	pilha = []; // limpa pilha
	nodos = 0;
	// gera nodo raiz a partir do estado do tabuleiro na tela (vazio ou com a primeira jogada do humano)
	raiz = {pai: null, estado: estado, filhos: [], jogador: "O", minimax: null};
	pilha.push(raiz);	// coloca na pilha
	
	document.getElementById("CPUcomeca").style.display = 'none';
	document.getElementById("info").style.display = '';
	document.getElementById("info").innerHTML = "Gerando árvore, aguarde...";
	
	while (pilha.length) {		// enquanto houver elementos na pilha
		nodo = pilha.pop();		// retira um nodo
		geraFilhos(nodo);		// e gera filhos desse nodo
	}

	calculaMinimax(raiz);	// calcula valores Minimax a partir da raiz
	
	document.getElementById("info").innerHTML = "Tamanho da árvore: "+nodos+" nodos";
	atual = raiz;	// situação atual do jogo
}
	
	
function geraFilhos(pai) {
	var estado = [];
	var x,y,minimax;
	var	jogador = (pai.jogador=="X")?"O":"X";	// verifica de quem é a vez de jogar nesse nível
	
	for (y=0; y<3; y++)
		for (x=0; x<3; x++)
			if (pai.estado[y][x] == undefined) {	// se encontrou espaço vago no tabuleiro
				estado = copiaEstado(pai.estado);	// gera uma cópia do estado atual
				estado[y][x] = jogador;				// adiciona a jogada
				var nodo = {pai: pai, estado: estado, filhos: [], jogador: jogador, minimax: null};	// cria um novo nodo para o filho

				nodo.minimax = ehTerminal(nodo.estado,0);	// se for nodo terminal, recebe valor de utilidade 
				pai.filhos.push(nodo);	// adiciona esse nodo no array de filhos do nodo pai
				nodos++;

				if (!nodo.minimax)		// se filho não é terminal, vai para a pilha, para gerar os filhos dele
					pilha.push(nodo);
			}
}

function calculaMinimax(nodo) {	// calcula o valor minimax de um nodo
	var i, min, max;
	for (i=0; i < nodo.filhos.length; i++) {	// percorre todos os filhos do nodo
		if (nodo.filhos[i].minimax === null)	// se um filho ainda não tem um valor minimax (não é folha da árvore)
			calculaMinimax(nodo.filhos[i]);		// chama a função recursivamente para aquele filho

		if (max == undefined || nodo.filhos[i].minimax > max)	// guarda valor max (maior minimax entre os filhos)
			max = nodo.filhos[i].minimax;
		if (min == undefined || nodo.filhos[i].minimax < min)	// guarda valor min (menor minimax entre os filhos)
			min = nodo.filhos[i].minimax;
	}
	if (nodo.jogador == "O")
		nodo.minimax = max;		// se a próxima jogada é da CPU, retorna valor max
	else
		nodo.minimax = min;		// caso contrário, retorna valor min
}

function ehTerminal(estado,encerra) {	// verifica se estado é terminal, retornando seu valor de utilidade
	var x,y;							// retorna null caso não seja estado terminal
	var brancos = 0;					// encerra = 0 para calcular o valor de utilidade durante a geração da árvore
	var utilidade = null;				//         = 1 para encerrar o jogo quando estado for terminal
	
	for (y=0; y<3; y++)		// testa linhas
		if (estado[y][0] != undefined && estado[y][0] == estado[y][1] && estado[y][0] == estado[y][2]) {
			utilidade = (estado[y][0] == "X")? 1: -1;	// utilidade 1 para X (CPU), -1 para O (humano)
			break;
		}
	if (!utilidade)			// testa colunas
		for (x=0; x<3; x++)	
			if (estado[0][x] != undefined && estado[0][x] == estado[1][x] && estado[0][x] == estado[2][x]) {
				utilidade = (estado[0][x] == "X")? 1: -1;
				break;
			}
	if (!utilidade)			// testa diagonais
		if ( estado[1][1] != undefined && (
			 (estado[0][0] == estado[1][1] && estado[0][0] == estado[2][2]) ||
			 (estado[0][2] == estado[1][1] && estado[0][2] == estado[2][0])    ) )
			utilidade = (estado[1][1] == "X")? 1: -1;
				
	for (y=0; y<3; y++)
		for (x=0; x<3; x++)
			if (estado[y][x] == undefined)	// conta espaços em branco no tabuleiro
				brancos++;
				
	if (utilidade)					// se achou um vencedor
		if (encerra)
			if (utilidade > 0)		// utilidade > 0 venceu CPU
				termina("Eu ganhei!");
			else
				termina("Você ganhou!");	// essa mensagem nunca será exibida :)
		else
			return utilidade*(brancos+1); 	// retorna valor de utilidade - nº de casas vagas dá um peso maior,
											// favorecendo a escolha da jogada vitoriosa no nível mais raso
	else							
		if (!brancos)				// se não tem mais espaços em branco também é terminal...
			if (encerra)
				termina("Empatamos!");
			else
				return 0;			// ...com utilidade 0 (empate)
		else
			return null; 			// se ainda tem brancos, não é terminal
}


function jogaHumano(elemento) {
	var i = Number(elemento.id.substr(1,1)); // pega linha a partir da id do elemento (ex. "p02")
	var j = Number(elemento.id.substr(2,1)); // pega coluna a partir da id do elemento

	if (estado[i][j] != undefined) {
		alert("Posição inválida");
		return;
	}
	else {
		estado[i][j] = "O";		// coloca a jogada do humano
		exibeEstado(estado);	// atualiza tabuleiro na tela
	}
	
	if (!ehTerminal(estado,1)) {	// verifica se jogada do humano resultou em um estado terminal
		if (!raiz)			// se raiz é null, árvore ainda não foi gerada (humano começa o jogo)
			geraArvore();	// a raiz será o estado atual, já com a jogada do humano
		else
			for (i=0;i < atual.filhos.length; i++)	// procura nos filhos do estado atual, qual representa a situação após a jogada do humano
				if (comparaEstados(estado,atual.filhos[i].estado)) {
					atual = atual.filhos[i];
					break;
				}
		jogaCPU();	// passa a vez para a CPU
	}
}

function jogaCPU() {
	var max;
	var opcoes = [];	// array das opções de jogadas
	var i,r;
	
	if (!raiz)			// se raiz é null, árvore ainda não foi gerada (CPU começa o jogo)
		geraArvore();

	document.getElementById("infoFilhos").style.display = '';	// limpa exibição dos filhos e netos
	document.getElementById("quadroFilhos").innerHTML = '';
	mostraNetos();
	
	// avalia qual a melhor opção de jogada, dentre as possíveis (filhos do estado atual)
	for (i=0;i < atual.filhos.length; i++) {
		mostraFilho(atual.filhos[i],i,0);
		if (atual.filhos[i].minimax != null && (max == undefined || atual.filhos[i].minimax > max))
			max = atual.filhos[i].minimax;	// salva maior valor minimax dos filhos
	}
	
	// percorre novamente os filhos, checando todos que tenham o mesmo valor minimax ótimo
	for (i=0;i < atual.filhos.length; i++)
		if (atual.filhos[i].minimax == max)
			opcoes.push(i);	// coloca índice deste filho no array de opções de jogada
		
	// e escolhe aleatoriamente um deles, para dar mais variedade às jogadas
	r = Math.floor(Math.random()*opcoes.length);
	atual = atual.filhos[opcoes[r]];
	estado = atual.estado;
	exibeEstado(estado);
	
	ehTerminal(estado,1);	// Verifica se atingiu estado terminal, encerrando o jogo 
}

/* funções de display */

function exibeEstado(estado) {	// atualiza tabuleiro na tela
	for (var i=0; i<3; i++)
		for (var j=0; j<3; j++) {
			elemento = document.getElementById("p"+i+j);
			if (estado[i][j] == undefined)
				elemento.innerHTML = "&nbsp;";
			else
				elemento.innerHTML = estado[i][j];
		}
}

function mostraFilho(nodo,i,n) {	// adiciona um nodo aos blocos de filhos ou netos, abaixo do tabuleiro
	var html;						// n=0 filhos, n=1 netos
	var x,y;
	
	if (n == 0)
		html = "<div class='bloco' id='b"+i+"' onClick='mostraNetos("+i+")'><pre>";	// gera blocos de filhos
	else
		html = "<div class='bloco ativo'><pre>";	// gera blocos de netos
	
	for (y=0; y<3; y++) {
		for (x=0; x<3; x++)
			if (nodo.estado[y][x] == undefined)
				html += "   ";
			else
				html += nodo.estado[y][x]+"  ";
		html += "\n";
	}
	html += nodo.minimax+"</pre></div>\n";
	
	if (n == 0) {
		document.getElementById("quadroFilhos").innerHTML += html;
		document.getElementById("quadroNetos"+i).innerHTML = '';
		for (x=0; x < nodo.filhos.length; x++)
			mostraFilho(nodo.filhos[x],i,1); // chama a função para gerar os blocos de netos
	}
	else
		document.getElementById("quadroNetos"+i).innerHTML += html;
}

function mostraNetos(n) {	// mostra/oculta blocos de netos
	var i;
	if (n != undefined)
		if (document.getElementById("quadroNetos"+n).style.display == '')	// se já está exibido, tem que ocultar
			n = undefined;	
	for (i=0; i<9; i++) {	// oculta todos os blocos
		document.getElementById("quadroNetos"+i).style.display = 'none';
		if (document.getElementById("b"+i))
			document.getElementById("b"+i).className = 'bloco';			// desmarca os pais (tira classe 'ativo')
	}
	if (n != undefined) {	// exibe o bloco desejado
		document.getElementById("quadroNetos"+n).style.display = '';
		if (document.getElementById("b"+n))
			document.getElementById("b"+n).className = 'bloco ativo';	// marca o bloco do pai 
	}
}

function termina(msg) {
	alert(msg);
	document.getElementById("reiniciar").style.display = '';
	document.getElementById("CPUcomeca").style.display = 'none';
}

/* funções auxiliares */

function copiaEstado(estado) {
	var retorno = [];
	for(var i = 0; i < estado.length; i++)	// copia elementos do array
		retorno[i] = estado[i].slice(0);	// necessário para evitar a cópia por referência
    
	return retorno;
}

function comparaEstados(estado1,estado2) {
	for (var i=0; i<3; i++)
		for (var j=0; j<3; j++)
			if (estado1[i][j] != estado2[i][j])
				return false;
				
	return true;
}


</script>
</head>

<body onLoad="inicializa();">

       <nav class="navbar navbar-expand-md bg-primary navbar-dark h-50">
    <div class="container-fluid">
   
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbar2SupportedContent" aria-controls="navbar2SupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button>
     

    </div>
       <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>

          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
          <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <i class="fa d-inline fa-lg fa-diamond"></i>
         <img src="imagens/Estou indo 8.gif" width="120"  alt="ABRIR LINKS" border="7">
          </li>
          
        </ul>
      </div>
  </nav>
    </div>
  </nav>
  <div class="text-center text-uppercase opaque-overlay h-100">
    <div class="container py-5 h-100">
      <div class="row">
        <div class="col-md-12 text-Dark text-center w-25">
          <p  style="font-family: arial;font-size: 88px;font-style: italic;
          font-weight: bolder;" class="display-3 mb-4"><u>
            VERSÃO  MINIMAX</u></p>
       
          <br/>
           </div>
      </div>
  </div>
  </div>
  </form>
        </div>
        <div class="col-4 col-md-2 align-self-center">
          <a href="https://www.facebook.com" target="_blank"><i class="fa fa-fw fa-facebook fa-3x text-white"></i></a>
        </div>
        <div class="col-4 col-md-1 align-self-center">
          <a href="https://twitter.com" target="_blank"><i class="fa fa-fw fa-twitter fa-3x text-white"></i></a>
        </div>
        <div class="col-4 col-md-1 align-self-center">
          <a href="https://www.instagram.com" target="_blank"><i class="fa fa-fw fa-instagram text-white fa-3x"></i></a>
        </div>
      </div>
          <hr style="border:4px solid #e6e6e6; " />
<div id="container">
  <div style="float:right">
	<!-- Google +1 button -->
	<g:plusone></g:plusone>
  </div>
  <h1>Jogo da Velha - Fundamentos de IA</h1>
  <h2>Um exercício de busca competitiva usando algoritmo MiniMax</h2>
  <div id="quadroesq">
    <table id="tabuleiro">
    <tr>
      <td id="p00" onClick="jogaHumano(this);"></td>
      <td id="p01" onClick="jogaHumano(this);"></td>
      <td id="p02" onClick="jogaHumano(this);"></td>
    </tr>
    <tr>
      <td id="p10" onClick="jogaHumano(this);"></td>
      <td id="p11" onClick="jogaHumano(this);"></td>
      <td id="p12" onClick="jogaHumano(this);"></td>
    </tr>
    <tr>
      <td id="p20" onClick="jogaHumano(this);"></td>
      <td id="p21" onClick="jogaHumano(this);"></td>
      <td id="p22" onClick="jogaHumano(this);"></td>
    </tr>
    </table>
  </div>

  <div id="quadrodir">
    <br/>
    <form>
      X = CPU<br>
      O = Humano<br><br>
      Clique em uma posição do tabuleiro para jogar<br><br><br>
      <input type="button" id="CPUcomeca" value=" CPU começa " onClick="jogaCPU();">
      <input type="button" id="reiniciar" value=" Jogar novamente " onClick="inicializa();">
    </form>

    <br/><br/>
    <div id="info"></div>
  </div>
  
  <div id="infoFilhos" class="clear"><br>Nodos avaliados para esta jogada: (clique em um para ver seus sucessores)</div>
  <div id="quadroFilhos" class="clear"></div>
  <div id="quadroNetos0" class="clear"></div>
  <div id="quadroNetos1" class="clear"></div>
  <div id="quadroNetos2" class="clear"></div>
  <div id="quadroNetos3" class="clear"></div>
  <div id="quadroNetos4" class="clear"></div>
  <div id="quadroNetos5" class="clear"></div>
  <div id="quadroNetos6" class="clear"></div>
  <div id="quadroNetos7" class="clear"></div>
  <div id="quadroNetos8" class="clear"></div>
</div>

</body>
</html>